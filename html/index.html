<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1,
      maximum-scale=1, shrink-to-fit=no">
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>兔子云印</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/css/mdui.min.css"
    integrity="sha384-cLRrMq39HOZdvE0j6yBojO4+1PrHfB7a9l5qLcmRm/fiWXYY+CndJPmyu5FV/9Tw" crossorigin="anonymous" />

  <!-- 新的UI框架 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/picnic">


</head>

<body class="mdui-theme-primary-pink mdui-theme-accent-pink
    mdui-bottom-nav-fixed">
  <div class="mdui-toolbar mdui-color-green-600">
    <a class="mdui-typo-title" style="font-family: Zpix,serif" href="/">打印！ -
      你看到了吗？</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:" class="mdui-btn mdui-btn-icon"><i class="mdui-icon
          material-icons">refresh</i></a>
  </div>

  <!-- 文件管理: -->
  <!-- <iframe src="file_manger.html" height="100%" width="100%" scrolling="no" frameborder="0"> -->
  <div class="mdui-container Custom-class-1">
    <div class="mdui-textfield">
      <div class="Custom-class-1">
        <h1>文件管理系统</h1>
        <h3>当前用户：<span id="user-name"></span></h3>
        <button id="login-button" style="width: 100px;">登录</button>
      </div>
      <hr>
      <form enctype="multipart/form-data" class="Custom-class-1">
        <h2>上传文件</h2>
        <div class="Custom-class-1" style="width:400px;height:60px;border: 2px
            solid grey;">
          <input style="width:200px;border:none;" type="file" name="file">
        </div>
        <div>
          <button id="auto-upload-button">自动上传</button>
          <button id="manual-upload-button">手动上传</button>
        </div>
      </form>

      <!-- 日志信息 -->
      <textarea id="log" rows="10" cols="50"></textarea>


      <!-- 上传进度条 -->
      <div id="progress-div" style="display: none;">
        <div id="progress-bar" style="background-color: #4CAF50; height: 20px;
            width: 0%;"></div>
      </div>


      <!-- 文件列表 -->
      <hr>
      <h2>文件列表</h2>
      <table>
        <thead>
          <tr>
            <th>文件名</th>
            <th>大小</th>
            <th>路径</th>
            <th>文件UUID</th>
            <th>操作</th>
            <th>操作</th>
            <th>操作</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="file-list">
        </tbody>
        <!-- 文件选择框 -->
      </table>
      <hr>
      <!-- 文件列表 -->


      <!-- 选择文件 -->
      <!-- 添加一个按钮或者表单元素 -->
      <button id="choose-file-button">选择文件</button>

      <!-- 在页面中显示当前选择的文件信息 -->
      <div id="selected-file-info"></div>

      <!-- 当前选择的文件 -->
      您选择了:<div id="selected-file-uuid"></div>
      <script>
        var selectedUUID  = "";
      </script>

      <script>
        const chooseFileButton = document.getElementById('choose-file-button');
        const selectedFileInfo = document.getElementById('selected-file-info');

        // 监听按钮的点击事件
        chooseFileButton.addEventListener('click', () => {
          // 创建一个 <input type="file"> 元素
          const fileInput = document.createElement('input');
          fileInput.type = 'file';

          // 监听文件选择事件
          fileInput.addEventListener('change', () => {
            const selectedFile = fileInput.files[0]; // 获取用户选择的文件
            // 在页面中显示文件信息
            selectedFileInfo.innerHTML = `
        <p>文件名：${selectedFile.name}</p>
        <p>文件类型：${selectedFile.type}</p>
        <p>文件大小：${selectedFile.size} 字节</p>
        <p>最后修改时间：${selectedFile.lastModifiedDate}</p>
      `;
          });

          // 触发文件选择对话框
          fileInput.click();
        });
      </script>
      <!-- 选择文件 -->

      <script>
        // 获取当前用户
        fetch('/api/wanna_login', {
          credentials: 'include'
        })
          .then(response => response.json())
          .then(data => {
            if (data.code == 201) {
              document.getElementById('user-name').innerText = data.logged_in_user_name;
            }
            if (data.code == 401) {
              document.getElementById('user-name').innerText = data.logged_in_user_name;
            } else {
              console.log("[dayi-error]获得用户出现错误")
              console.log(data.info);
            }
          });

        // 登录按钮点击事件
        document.getElementById('login-button').addEventListener('click', (event) => {
          event.preventDefault();
          fetch('/api/wanna_login', {
            credentials: 'include'
          })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                document.getElementById('user-name').innerText = data.data;
              } else {
                alert(data.info);
              }
            });
        });

        //获得选择文件的UUID
        // 获取所有选中的文件的UUID
       // const selectedFiles = Array.from(document.getElementsByName('selected-file'))
        //  .filter(cb => cb.checked)
        //  .map(cb => cb.value);

        // 获取所有选中的文件的路径名和UUID
//        const selectedFileDetails = Array.from(document.getElementsByName('selected-file'))
//          .filter(cb => cb.checked)
//          .map(cb => {
//            const row = cb.closest('tr');
//            return {
//              path: row.cells[2].innerText,
//              uuid: cb.value,
//            };
//          });
          const selectedFiles = [];
          function fetchUserFiles() {
            fetch('/api/get_user_files', {
              credentials: 'include'
            })
              .then(response => response.json())
              .then(data => {
                if (data.code == 201) {
                  const fileList = document.getElementById('file-list')
                  fileList.innerHTML = ''
                  const files = data.data
                  files.forEach(file => {
                    const row = document.createElement('tr')
                    const sizeCell = document.createElement('td')
                    sizeCell.innerText = formatFileSize(file.file_size)
                    const pathCell = document.createElement('td')
                    pathCell.innerText = file.file_path
                    const uuidCell = document.createElement('td')
                    uuidCell.innerText = file.uuid

                    const downloadCell = document.createElement('td')
                    const downloadBtn = document.createElement('button')
                    downloadBtn.innerText = '下载'
                    
//文件选择                    
const selected_file_cell = document.createElement('td')
const selected_file_Btn = document.createElement('button')
selected_file_Btn.innerText = '选择我'

selected_file_cell.appendChild(selected_file_Btn)
selected_file_Btn.classList.add('btn', 'btn-info')
selected_file_Btn.addEventListener('click', () => {

  selectedUUID = file.uuid
  //显示当前的UUID
  document.getElementById("selected-file-uuid").innerText = selectedUUID

  console.log(selectedUUID)
})

      
                    //删除按钮
                    const deleteCell = document.createElement('td')
                    const deleteBtn = document.createElement('button')
                    deleteBtn.innerText = '删除'
                    deleteBtn.classList.add('btn', 'btn-danger')
                    deleteBtn.addEventListener('click', () => {
                      deleteFile(file.uuid)
                    })
                    deleteCell.appendChild(deleteBtn)


                    //文件名
                    const filenameCell = document.createElement('td')
                    filenameCell.innerText = file.file_name
      
      
                    row.appendChild(filenameCell)
                    row.appendChild(sizeCell)
                    row.appendChild(pathCell)
                    row.appendChild(uuidCell)
                    row.appendChild(downloadCell)
                    row.appendChild(deleteCell)
                    row.appendChild(selected_file_cell)

                    fileList.appendChild(row)
                  })
                } else if (data.code == 401) {
                  console.log('[dayi-error]用户未登录')
                  // 用户未登录，跳转到登录页面
                  // window.location.replace('/login.html')
                } else {
                  alert(data.info)
                }
              })
              .catch(error => console.error(error))
          }

        
        // 下载文件
        function downloadFile(uuid) {
          window.location.href = '/api/download_file/' + uuid;
        }
        // 格式化文件大小
        function formatFileSize(size) {
          if (size < 1024) {
            return size + ' B'
          } else if (size < 1024 * 1024) {
            return (size / 1024).toFixed(2) + ' KB'
          } else {
            return (size / (1024 * 1024)).toFixed(2) + ' MB'
          }
        }

        // 删除文件
        function deleteFile(uuid) {
          if (!confirm('确定要删除该文件吗？')) {
            return
          }
          fetch('/api/delete_file/' + uuid, {
            credentials: 'include'
          })
            .then(response => response.json())
            .then(data => {
              if (data.code == 201) {
                fetchUserFiles()
              } else if (data.code == 401) {
                console.log('[dayi-error]错误')
                console.log(data)
                // window.location.replace('/login.html')
              } else {
                alert(data.info)
              }
            })
            .catch(error => console.error(error))
        }

        // 页面加载完成时获取用户文件列表
        window.onload = function () {
          // 获取当前用户
          fetch('/api/wanna_login', {
            credentials: 'include'
          })
            .then(response => response.json())
            .then(data => {
              if (data.code == 201) {
                document.getElementById('user-name').innerText = data.logged_in_user_name;
              }
              if (data.code == 401) {
                document.getElementById('user-name').innerText = data.logged_in_user_name;
              } else {
                console.log("[dayi-error]获得用户出现错误")
                console.log(data.info);
              }
            });

          // 获得用户名
          const userLabel = document.getElementById('user-label')
          fetch('/api/get_user_name', {
            credentials: 'include'
          })
            .then(response => response.json())
            .then(data => {
              if (data.code == 201 || data.code == 401) {
                userLabel.innerText = '当前用户：' + data.user_namel;
                fetchUserFiles();
              } else {
                alert(data.info)
              }
            })
            .catch(error => console.error(error))

          // 页面加载完成时获取用户文件列表
          fetchUserFiles()
        }
        //上传文件函数
        function uploadFile(formData) {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/api/file_upload', true);
          xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

          const progressDiv = document.getElementById('progress-div');
          const progressBar = document.getElementById('progress-bar');
          progressDiv.style.display = 'block';
          progressBar.style.width = '0%';

          xhr.upload.addEventListener('progress', (event) => {
            if (event.lengthComputable) {
              const percent = (event.loaded / event.total) * 100;
              progressBar.style.width = `${percent}%`;
            }
          });

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              if (response.code == 201) {
                console.log('[dayi-info]上传成功');
                fetchUserFiles();
              } else {
                console.error(`[dayi-error]${JSON.stringify(response)}`);
                alert(`上传失败,错误信息: JSON.stringify(response)`);
              }
            }
            fetchUserFiles();
          };

          xhr.send(formData);
        }

        //上传按钮
        document.getElementById('manual-upload-button').addEventListener('click', (event) => {
          event.preventDefault();
          const fileInput = document.querySelector('input[type="file"]');
          const file = fileInput.files[0];
          const formData = new FormData();
          formData.append('file', file);
          uploadFile(formData);
        });
      </script>
      <script>
        // 日志信息
        const logTextarea = document.getElementById('log');
        function log(message) {
          logTextarea.value += message + '\n';
        }

        function uploadFile(formData) {
          const xhr = new XMLHttpRequest();
          xhr.upload.addEventListener('progress', handleProgress);
          xhr.addEventListener('load', handleLoad);
          xhr.addEventListener('error', handleError);
          xhr.addEventListener('abort', handleAbort);

          xhr.open('POST', '/api/file_upload');
          xhr.send(formData);

          function handleProgress(event) {
            const percent = event.loaded / event.total * 100;
            log(`上传进度：${percent.toFixed(2)}%`);
          }

          function handleLoad(event) {
            const response = JSON.parse(xhr.responseText);
            if (response.code == 201) {
              log('上传成功');
            } else {
              log(`上传失败：${response.info}`);
            }
            fetchUserFiles();
          }

          function handleError(event) {
            log('上传出错');
          }

          function handleAbort(event) {
            log('上传已取消');
          }
        }
      </script>
      <!-- </iframe> -->
    </div>
  </div>
  </script>

  <div id="header"></div>
  <!-- 文件管理: -->
  <!-- 文件管理: -->

  <!-- 文件选择 -->
  <div class="mdui-container">
    <div class="mdui-textfield">
      <form class="Custom-class-1" id="myForm" action="./uploader" method="POST" enctype="multipart/form-data">
        <!-- 文件选择框 -->
        <div>
          <label class="Custom-class-1">
            <h3>选择文件：</h3>
            <div class="Custom-class-1" style="width:400px;height:60px;border: 2px
            solid grey;">
              <input style="width:200px;border:none;" type="file" name="file">
            </div>
          </label>
        </div>

        <!-- 黑白打印选项 -->
        <label>
          <input type="checkbox" name="blackAndWhitePrinting">
          <span class="checkable">黑白打印</span>

        </label>

        <!-- 删除文件选项 -->
        <div>
          <label>
            <input id="deleteAfterPrinting" name="deleteAfterPrinting" type="checkbox">
            <span class="checkable">打印完立即删除文件</span>
          </label>
        </div>

        <!-- 打印全部页码选项 -->
        <div>
          <label>
            <input id="printAllPages" name="printAllPages" type="checkbox" checked>
            <span class="checkable">打印全部页码</span>
          </label>
        </div>

        <!-- 自定义页码范围选项 -->
        <div>
          <label class="Custom-class-1">
            自定义页码范围：
            <input style="width:400px" z id="pageRange" name="pageRange" type="text" placeholder="例如：1-5,7,10-12">
          </label>
        </div>
        <button style="width: 100px;" type="submit">上传</button>
    </div>

    <!-- 服务器实时状态 -->
    <div class="mdui-container Custom-class-1" style="padding-top:50px;">
      <div class="mdui-textfield">
        <div>
          <a>实时打印信息:</a>
          <div id="print-info">获取中...</div>
          <a class="Custom-class-1">
            <div>python服务器实时时间:</div>
            <div id="dayi-time">正在获取时间...</div>
            <!-- <br> -->
            <div>NODE服务器状态检测:</div>
            <div id="node-status">
              正在检测服务器状态...
            </div>
            <br><br>
          </a>
        </div>
      </div>
    </div>
    <!-- 服务器实时状态 -->



    <!-- 获得表单数据 -->
    <script>
      //拦截提交跳转
      const form = document.getElementById("myForm");
      form.addEventListener("submit", submitForm);
      function submitForm() {
        event.preventDefault();
        const form = document.getElementById("myForm");
        const formData = new FormData(form);

        const jsonData = {};
        for (const [key, value] of formData.entries()) {
          jsonData[key] = value;
        }
        jsonData['file'] = selectedUUID;

        console.log(jsonData);
        
        fetch("./api-v2/post_json", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            code: "201",
            info: "前端传递的数据",
            data: jsonData
          })
        }).then(response => {
          if (!response.ok) {
            throw new Error(response.statusText);
          }
          return response.json();
        }).then(data => {
          console.log(data);
        }).catch(error => {
          console.error(error);
        });
      }
    </script>

    <!-- 实时打印状态显示 -->
    <div class="mdui-container">
      <div class="mdui-textfield">
    <div>
      <script>
          // 定义请求 API 的函数
          function getPrintInfo() {
              var xhr = new XMLHttpRequest();
              xhr.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                      var data = JSON.parse(this.responseText);
                      if (data.code == "201") {
                          // 更新页面上的打印信息
                          var printInfoDiv = document.getElementById("print-info");
                          printInfoDiv.innerHTML = "";
                          for (var i = 0; i < data.data.length; i++) {
                              var p = document.createElement("p");
                              p.innerText = data.data[i];
                              printInfoDiv.appendChild(p);
                          }
                      }
                  }
              };
              xhr.open("GET", "/api-v2/realtime-print-info", true);
              xhr.send();
          }
          // 每 2 秒钟请求一次 API
          setInterval(getPrintInfo, 2000);
    </script>
    </div></div></div>
    

    <!-- 测试后端服务器状态 -->
    <div class="mdui-container">
      <div class="mdui-textfield">
        <div>
          <script>
            function checkServerStatus() {
              const st = document.getElementById('node-status')
              fetch('/api/test').then(response => response.json())
                .then(data => {
                  if (data.code == 201) {
                    st.innerText = '文件服务器运行正常 √';
                  } else {
                    st.innerText = '文件服务器运行异常 ×';
                  }
                })
                .catch(error => {
                  st.innerText = '请求服务器出错 ×，文件服务器运行异常 ×';
                });
            }
            setInterval(checkServerStatus, 5000);
            checkServerStatus();
          </script>
        </div>
      </div>
    </div>
    <!-- 测试后端服务器状态 -->


    <div class="mdui-bottom-nav mdui-color-green-100">
      <a href="" class="mdui-ripple mdui-bottom-nav-active">
        <i class="mdui-icon material-icons">insert_emoticon</i>
        <label>刷新</label>
      </a>
    </div>

    <div class="mdui-dialog" id="message">
      <div class="mdui-dialog-title" id="message_title">标题</div>
      <div class="mdui-dialog-content" id="message_content">内容</div>
      <div class="mdui-dialog-actions">
        <button class="mdui-btn mdui-ripple" mdui-dialog-close>关闭</button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/js/mdui.min.js"
      integrity="sha384-gCMZcshYKOGRX9r6wbDrvF+TcCCswSHFucUzUPwka+Gr+uHgjlYvkABr95TCOz3A" crossorigin="anonymous">
      </script>

    <script>
      window.addEventListener('load', function () {
        FastClick.attach(document.body);
      }, false);
    </script>


    <!-- 获得实时时间 -->
    <script>
      const timeDiv = document.getElementById("dayi-time");
      setInterval(() => {
        fetch("./api-v2/time")
          .then(response => response.json())
          .then(data => {
            // console.log(data);
            const time = data.data[0];
            timeDiv.innerText = time;
          })
          .catch(error => console.error(error));
      }, 1000);
    </script>
    <!-- 获得实时时间 -->





</body>
<style>
  .Custom-class-1 {
    display: flex;
    flex-direction: column;
    /*设置主轴为竖直方向*/
    justify-content: center;
    /*在主轴上居中*/
    align-items: center;
    /*在侧轴上居中*/
  }
</style>

</html>